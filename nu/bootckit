#!/usr/bin/nu

use hostexec.nu

source images.nu
source entrypoint.nu
source virtinstall.nu

def init [] {
    
}

// Always call this early on
let bootckit_env = /usr/libexec/bootc-kit-backend init-environment | from json

# Print a welcome message
def "main welcome" [] {
    print "Welcome to bootc-kit, an interactive shell for bootc development."
    print 'This is an instance of nu (https://www.nushell.sh). Type `bootckit help` for help.'
    if (not $bootckit_env.container) {
        print '  NOTE: No container environment detected.'
        return
    }
    if (not $bootckit_env.privileged) {
        print '  NOTE: This container is running without `--privileged`. Functionality will be reduced.'
        return
    }
    if (not $bootckit_env.pidhost) {
        print '  NOTE: This container is running without `--pid=host`. Functionality will be reduced.'
        return
    }
    if (not (hostexec check)) {
        print '  WARN: Executing host command via `systemd-run` failed. Functionality will be reduced.'
    }
}

def "main shell" [] {
    main welcome
    nu
}

export def main [] {
    help bootckit
}